{{ $montserrat := resources.Get "fonts/montserrat-v31-latin-regular.woff2" | fingerprint "md5" }}
{{ $montserrat700 := resources.Get "fonts/montserrat-v31-latin-700.woff2" | fingerprint "md5" }}
{{ $londrina := resources.Get "fonts/londrina-solid-v19-latin-regular.woff2" | fingerprint "md5" }}

{{ $sassVars := dict 
    "montserrat-path" (strings.TrimPrefix "/assets" $montserrat.RelPermalink) 
    "montserrat700-path" (strings.TrimPrefix "/assets" $montserrat700.RelPermalink) 
    "londrina-path" (strings.TrimPrefix "/assets" $londrina.RelPermalink) 
}}

{{ $opts := dict 
    "transpiler" "libsass" 
    "targetPath" "css/main.css" 
    "includePaths" (slice "assets/scss" "node_modules") 
    "vars" $sassVars 
}}
{{ $css := resources.Get "scss/main.scss" | resources.ExecuteAsTemplate "main.scss" . | toCSS $opts | postCSS | minify }}

{{ $isSkipCheck := default false .Site.Params.ignoresmallcsscheck }}

{{/* 14KB Budget Check */}}
{{ $size := len $css.Content }}
{{ if gt $size 14336 }}
  {{ errorf "⚠️ CSS BUDGET EXCEEDED: %d bytes" $size }}
{{ else }}
  {{ warnf "CSS: %d bytes" $size }}
{{ end }}

{{/* Minimum Size Check (Ensures Bootstrap isn't missing) */}}
{{ if and (lt $size 3000) (not $isSkipCheck) }}
  {{ errorf "⚠️ CSS TOO SMALL: %d bytes. Bootstrap likely failed to bundle." $size }}
{{ end }}

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="sHtCk3cwlffILNVMXLXBJh8DlttBpCVkZWYWRjZZ6RY" />

{{- $desc := "" -}}

{{- if .Params.description -}}
    {{/* Look specifically in the Params map first */}}
    {{- $desc = .Params.description -}}
{{- else if .Description -}}
    {{/* Look in the standard Hugo Description field */}}
    {{- $desc = .Description -}}
{{- else if .Site.Params.description -}}
    {{/* Fallback to config.toml */}}
    {{- $desc = .Site.Params.description -}}
{{- end -}}

{{- if $desc -}}
    <meta name="description" content="{{ $desc | plainify | htmlEscape }}">
{{- else -}}
    {{- end -}}

<title>{{ .Title }} - {{ .Site.Params.ShortTitle }}</title>

<link rel="preload" href="{{ $montserrat.RelPermalink }}" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="{{ $montserrat700.RelPermalink }}" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="{{ $londrina.RelPermalink }}" as="font" type="font/woff2" crossorigin="anonymous">

{{ $prodBaseURL := "https://edibleloughborough.org.uk" }}
{{ $canonical := replace .Permalink .Site.BaseURL $prodBaseURL }}

<link rel="canonical" href="{{ $canonical }}">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<style>
  {{ $css.Content | safeCSS }}
</style>

{{ $opts := dict "transpiler" "libsass" "targetPath" "css/_footer.css" }}
{{ $footerCSS := resources.Get "scss/_footer.scss" | toCSS $opts | minify | fingerprint }}
<link rel="preload" href="{{ $footerCSS.RelPermalink }}" as="style">
<link rel="stylesheet" href="{{ $footerCSS.RelPermalink }}" media="all">

{{ $opts := dict "minify" true "target" "es2015" }}
{{ with resources.Get "js/site.js" | js.Build $opts | fingerprint }}
  <script src="{{ .RelPermalink }}" defer></script>
{{ end }}

<script>
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on("init", user => {
      if (!user) {
        window.netlifyIdentity.on("login", () => {
          document.location.href = "/admin/";
        });
      }
    });
  }
</script>

{{ if eq .RelPermalink "/contact-us/" }}
  <script src="https://elfsightcdn.com/platform.js" data-use-service-core defer></script>
{{ end }}